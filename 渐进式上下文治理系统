最终方案：渐进式上下文治理系统                                                                                                                                                                            
                                                                                                                                                                                                            
  核心理念                                                                                                                                                                                                  
                                                                                                                                                                                                            
  视频懒加载 + 语义分层 + 事件驱动 + 自动复合                                                                                                                                                               
                                                                                                                                                                                                            
  ---                                                                                                                                                                                                       
  架构总览                                                                                                                                                                                                  
                                                                                                                                                                                                            
  ┌─────────────────────────────────────────────────────────────────┐                                                                                                                                       
  │                        Context Governor                          │                                                                                                                                      
  ├─────────────────────────────────────────────────────────────────┤                                                                                                                                       
  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │                                                                                                                                        
  │  │ Capture │→│ Compress│→│  Index  │→│ Retrieve│             │                                                                                                                                          
  │  │  Hook   │  │ Engine  │  │  Store  │  │  Layer  │             │                                                                                                                                       
  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘            │                                                                                                                                        
  ├─────────────────────────────────────────────────────────────────┤                                                                                                                                       
  │                     Storage Layers                               │                                                                                                                                      
  │  ┌──────────────────────────────────────────────────────────┐   │                                                                                                                                       
  │  │ L0 Hot    │ 完整内容 │ 当前任务 │ 内存      │ 即时     │   │                                                                                                                                         
  │  │ L1 Warm   │ 结构摘要 │ 本会话   │ SQLite    │ <100ms   │   │                                                                                                                                         
  │  │ L2 Cold   │ 语义索引 │ 跨会话   │ Vector DB │ <500ms   │   │                                                                                                                                         
  │  │ L3 Archive│ 压缩存档 │ 长期     │ 文件系统  │ 按需     │   │                                                                                                                                         
  │  └──────────────────────────────────────────────────────────┘   │                                                                                                                                       
  └─────────────────────────────────────────────────────────────────┘                                                                                                                                       
                                                                                                                                                                                                            
  ---                                                                                                                                                                                                       
  1. 自动捕获层（Hooks）                                                                                                                                                                                    
                                                                                                                                                                                                            
  # ~/.claude/hooks.yaml                                                                                                                                                                                    
  hooks:                                                                                                                                                                                                    
    PostToolUse:                                                                                                                                                                                            
      - script: context-governor/capture.ts                                                                                                                                                                 
        events: [Read, Edit, Write, Bash, Grep]                                                                                                                                                             
                                                                                                                                                                                                            
    PreCompact:                                                                                                                                                                                             
      - script: context-governor/compound.ts  # 压缩前自动复合                                                                                                                                              
                                                                                                                                                                                                            
    SessionEnd:                                                                                                                                                                                             
      - script: context-governor/archive.ts                                                                                                                                                                 
                                                                                                                                                                                                            
  捕获内容：                                                                                                                                                                                                
  interface Observation {                                                                                                                                                                                   
    id: string;                                                                                                                                                                                             
    timestamp: number;                                                                                                                                                                                      
    type: 'file_read' | 'file_edit' | 'decision' | 'error' | 'discovery';                                                                                                                                   
                                                                                                                                                                                                            
    // L0: 完整内容                                                                                                                                                                                         
    raw: string;                                                                                                                                                                                            
                                                                                                                                                                                                            
    // L1: 结构摘要（自动生成）                                                                                                                                                                             
    summary: {                                                                                                                                                                                              
      action: string;      // "修改了用户认证逻辑"                                                                                                                                                          
      files: string[];     // ["src/auth/login.ts"]                                                                                                                                                         
      keywords: string[];  // ["OAuth", "JWT", "认证"]                                                                                                                                                      
    };                                                                                                                                                                                                      
                                                                                                                                                                                                            
    // L2: 语义向量                                                                                                                                                                                         
    embedding?: number[];                                                                                                                                                                                   
                                                                                                                                                                                                            
    // 元数据                                                                                                                                                                                               
    tokens: number;                                                                                                                                                                                         
    importance: 'critical' | 'high' | 'medium' | 'low';                                                                                                                                                     
  }                                                                                                                                                                                                         
                                                                                                                                                                                                            
  ---                                                                                                                                                                                                       
  2. 渐进式压缩引擎                                                                                                                                                                                         
                                                                                                                                                                                                            
  // 压缩策略：类似视频的多分辨率                                                                                                                                                                           
  const compressionLevels = {                                                                                                                                                                               
    // 原始 → L1：提取结构                                                                                                                                                                                  
    toSummary: (raw: string) => ({                                                                                                                                                                          
      what: extractAction(raw),                                                                                                                                                                             
      where: extractFiles(raw),                                                                                                                                                                             
      why: extractReasoning(raw),                                                                                                                                                                           
      tokens: countTokens(raw) → ~5% 原始大小                                                                                                                                                               
    }),                                                                                                                                                                                                     
                                                                                                                                                                                                            
    // L1 → L2：生成索引                                                                                                                                                                                    
    toIndex: (summary: Summary) => ({                                                                                                                                                                       
      id: summary.id,                                                                                                                                                                                       
      keywords: summary.keywords,                                                                                                                                                                           
      embedding: generateEmbedding(summary),                                                                                                                                                                
      tokens: ~50 tokens                                                                                                                                                                                    
    }),                                                                                                                                                                                                     
                                                                                                                                                                                                            
    // L2 → L3：归档压缩                                                                                                                                                                                    
    toArchive: (observations: Observation[]) => ({                                                                                                                                                          
      period: '2026-02-07',                                                                                                                                                                                 
      decisions: extractDecisions(observations),                                                                                                                                                            
      patterns: extractPatterns(observations),                                                                                                                                                              
      // 使用 TLDR 5层分析压缩代码                                                                                                                                                                          
      codeGraph: generateTLDR(observations)                                                                                                                                                                 
    })                                                                                                                                                                                                      
  };                                                                                                                                                                                                        
                                                                                                                                                                                                            
  TLDR 代码分析（借鉴 Continuous-Claude）：                                                                                                                                                                 
  原始代码 → AST → 调用图 → 控制流 → 数据流 → 依赖图                                                                                                                                                        
  23,000 tokens → 1,200 tokens（95% 压缩）                                                                                                                                                                  
                                                                                                                                                                                                            
  ---                                                                                                                                                                                                       
  3. 智能检索层（懒加载核心）                                                                                                                                                                               
                                                                                                                                                                                                            
  // 3层渐进式检索（类似视频懒加载）                                                                                                                                                                        
  class ContextRetriever {                                                                                                                                                                                  
                                                                                                                                                                                                            
    // Layer 1: 快速索引（~50 tokens）                                                                                                                                                                      
    async searchIndex(query: string): Promise<IndexResult[]> {                                                                                                                                              
      return this.vectorDB.search(query, { limit: 20 });                                                                                                                                                    
      // 返回: [{ id, score, keywords }]                                                                                                                                                                    
    }                                                                                                                                                                                                       
                                                                                                                                                                                                            
    // Layer 2: 摘要预览（~500 tokens）                                                                                                                                                                     
    async getSummaries(ids: string[]): Promise<Summary[]> {                                                                                                                                                 
      return this.sqlite.query('SELECT summary FROM observations WHERE id IN (?)', ids);                                                                                                                    
      // 返回: [{ id, action, files, reasoning }]                                                                                                                                                           
    }                                                                                                                                                                                                       
                                                                                                                                                                                                            
    // Layer 3: 完整内容（按需加载）                                                                                                                                                                        
    async getFullContent(ids: string[]): Promise<Observation[]> {                                                                                                                                           
      return this.sqlite.query('SELECT * FROM observations WHERE id IN (?)', ids);                                                                                                                          
    }                                                                                                                                                                                                       
                                                                                                                                                                                                            
    // 智能检索：根据相关性自动决定加载深度                                                                                                                                                                 
    async smartRetrieve(query: string, budget: number = 2000): Promise<Context> {                                                                                                                           
      const indices = await this.searchIndex(query);                                                                                                                                                        
                                                                                                                                                                                                            
      let context: Context = { indices: [], summaries: [], full: [] };                                                                                                                                      
      let usedTokens = 0;                                                                                                                                                                                   
                                                                                                                                                                                                            
      for (const idx of indices) {                                                                                                                                                                          
        if (usedTokens > budget) break;                                                                                                                                                                     
                                                                                                                                                                                                            
        if (idx.score > 0.9) {                                                                                                                                                                              
          // 高相关：加载完整内容                                                                                                                                                                           
          const full = await this.getFullContent([idx.id]);                                                                                                                                                 
          context.full.push(full);                                                                                                                                                                          
          usedTokens += full.tokens;                                                                                                                                                                        
        } else if (idx.score > 0.7) {                                                                                                                                                                       
          // 中相关：加载摘要                                                                                                                                                                               
          const summary = await this.getSummaries([idx.id]);                                                                                                                                                
          context.summaries.push(summary);                                                                                                                                                                  
          usedTokens += 100;                                                                                                                                                                                
        } else {                                                                                                                                                                                            
          // 低相关：仅保留索引                                                                                                                                                                             
          context.indices.push(idx);                                                                                                                                                                        
          usedTokens += 10;                                                                                                                                                                                 
        }                                                                                                                                                                                                   
      }                                                                                                                                                                                                     
                                                                                                                                                                                                            
      return context;                                                                                                                                                                                       
    }                                                                                                                                                                                                       
  }                                                                                                                                                                                                         
                                                                                                                                                                                                            
  ---                                                                                                                                                                                                       
  4. 事件驱动的自动治理                                                                                                                                                                                     
                                                                                                                                                                                                            
  // 触发条件                                                                                                                                                                                               
  const triggers = {                                                                                                                                                                                        
    // 基于使用率                                                                                                                                                                                           
    contextUsage: {                                                                                                                                                                                         
      70: () => compressWarmToIndex(),   // 70% 时压缩温区                                                                                                                                                  
      85: () => archiveColdLayer(),       // 85% 时归档冷区                                                                                                                                                 
      95: () => emergencyCompact()        // 95% 紧急压缩                                                                                                                                                   
    },                                                                                                                                                                                                      
                                                                                                                                                                                                            
    // 基于事件                                                                                                                                                                                             
    events: {                                                                                                                                                                                               
      taskSwitch: () => demoteCurrentContext(),  // 任务切换时降级                                                                                                                                          
      fileChange: (file) => invalidateCache(file), // 文件变更时失效                                                                                                                                        
      errorOccur: (err) => preserveErrorContext(err), // 错误时保留上下文                                                                                                                                   
    },                                                                                                                                                                                                      
                                                                                                                                                                                                            
    // 基于时间                                                                                                                                                                                             
    idle: {                                                                                                                                                                                                 
      5: () => generateSummaries(),      // 闲置 5 轮生成摘要                                                                                                                                               
      10: () => moveToIndex(),           // 闲置 10 轮移到索引                                                                                                                                              
      session_end: () => archiveAll()    // 会话结束归档                                                                                                                                                    
    }                                                                                                                                                                                                       
  };                                                                                                                                                                                                        
                                                                                                                                                                                                            
  ---                                                                                                                                                                                                       
  5. Ledger 决策追踪（借鉴 Continuous-Claude）                                                                                                                                                              
                                                                                                                                                                                                            
  # .context/ledger.yaml - 每次会话自动更新                                                                                                                                                                 
  session: "2026-02-07-001"                                                                                                                                                                                 
  project: "dramalens"                                                                                                                                                                                      
                                                                                                                                                                                                            
  decisions:                                                                                                                                                                                                
    - id: "d001"                                                                                                                                                                                            
      time: "10:30"                                                                                                                                                                                         
      type: "architecture"                                                                                                                                                                                  
      choice: "使用 Zustand 而非 Redux"                                                                                                                                                                     
      reasoning: "项目规模小，Zustand 更轻量"                                                                                                                                                               
      files: ["src/store/index.ts"]                                                                                                                                                                         
                                                                                                                                                                                                            
    - id: "d002"                                                                                                                                                                                            
      time: "11:15"                                                                                                                                                                                         
      type: "bugfix"                                                                                                                                                                                        
      choice: "添加 null check"                                                                                                                                                                             
      reasoning: "API 可能返回空数据"                                                                                                                                                                       
      files: ["src/api/user.ts:45"]                                                                                                                                                                         
                                                                                                                                                                                                            
  file_claims:                                                                                                                                                                                              
    "src/auth/*": "已完成 OAuth 集成"                                                                                                                                                                       
    "src/api/*": "需要添加错误处理"                                                                                                                                                                         
                                                                                                                                                                                                            
  dirty_flag: 12  # 变更计数，>20 时触发自动 handoff                                                                                                                                                        
                                                                                                                                                                                                            
  next_session_hint: |                                                                                                                                                                                      
    继续完成报告导出功能                                                                                                                                                                                    
    注意：PDF 库有内存泄漏问题，需要手动释放                                                                                                                                                                
                                                                                                                                                                                                            
  ---                                                                                                                                                                                                       
  6. 统一 Skill 接口                                                                                                                                                                                        
                                                                                                                                                                                                            
  // 整合到现有 skill 体系                                                                                                                                                                                  
  const contextGovernor = {                                                                                                                                                                                 
    // 自动模式（默认）                                                                                                                                                                                     
    auto: true,                                                                                                                                                                                             
                                                                                                                                                                                                            
    // 手动命令                                                                                                                                                                                             
    commands: {                                                                                                                                                                                             
      '/ctx status': () => showContextUsage(),                                                                                                                                                              
      '/ctx save [tag]': (tag) => forceSaveWithTag(tag),                                                                                                                                                    
      '/ctx recall [query]': (query) => smartRetrieve(query),                                                                                                                                               
      '/ctx compact': () => manualCompact(),                                                                                                                                                                
      '/ctx archive': () => archiveSession(),                                                                                                                                                               
    },                                                                                                                                                                                                      
                                                                                                                                                                                                            
    // 与现有 skill 整合                                                                                                                                                                                    
    integrations: {                                                                                                                                                                                         
      'memory-manager': 'replace',  // 替换为新系统                                                                                                                                                         
      'req-flow': 'enhance',        // 增强需求流程的上下文                                                                                                                                                 
      'vibe-pm': 'enhance',         // 增强项目管理的上下文                                                                                                                                                 
    }                                                                                                                                                                                                       
  };                                                                                                                                                                                                        
                                                                                                                                                                                                            
  ---                                                                                                                                                                                                       
  7. 存储结构                                                                                                                                                                                               
                                                                                                                                                                                                            
  ~/.claude/                                                                                                                                                                                                
  ├── context/                                                                                                                                                                                              
  │   ├── hot/                    # L0: 当前会话（内存映射）                                                                                                                                                
  │   │   └── current.json                                                                                                                                                                                  
  │   │                                                                                                                                                                                                     
  │   ├── warm/                   # L1: 结构摘要                                                                                                                                                            
  │   │   └── observations.sqlite                                                                                                                                                                           
  │   │                                                                                                                                                                                                     
  │   ├── cold/                   # L2: 语义索引                                                                                                                                                            
  │   │   └── vectors.chroma/                                                                                                                                                                               
  │   │                                                                                                                                                                                                     
  │   └── archive/                # L3: 长期存档                                                                                                                                                            
  │       ├── 2026-02/                                                                                                                                                                                      
  │       │   ├── week-06.yaml    # 周度决策摘要                                                                                                                                                            
  │       │   └── patterns.yaml   # 识别的模式                                                                                                                                                              
  │       └── projects/                                                                                                                                                                                     
  │           └── dramalens/                                                                                                                                                                                
  │               └── ledger.yaml                                                                                                                                                                           
                                                            
