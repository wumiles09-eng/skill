---
name: deployment-and-ops
description: éƒ¨ç½²ä¸è¿ç»´ï¼ˆéƒ¨ç½²/è¿ç§»/å›æ»š/ç›‘æ§/å‘Šè­¦ï¼‰ã€‚ç”ŸæˆRunbookå’ŒRelease Notesã€‚å½“éœ€è¦éƒ¨ç½²ã€é…ç½®ç›‘æ§ã€å¤„ç†ç”Ÿäº§é—®é¢˜æ—¶ä½¿ç”¨ã€‚
---

# Deployment and Ops - éƒ¨ç½²ä¸è¿ç»´

## ç›®æ ‡

å®‰å…¨ã€å¯é åœ°éƒ¨ç½²åº”ç”¨ï¼Œå¹¶å»ºç«‹ç›‘æ§å’Œå‘Šè­¦ä½“ç³»ã€‚

## éƒ¨ç½²æµç¨‹

### 1. éƒ¨ç½²å‰æ£€æŸ¥

```markdown
## Pre-deployment Checklist

### ä»£ç å‡†å¤‡
- [ ] ä»£ç å·²åˆå¹¶åˆ°å‘å¸ƒåˆ†æ”¯
- [ ] ç‰ˆæœ¬å·å·²æ›´æ–°
- [ ] Changelogå·²æ›´æ–°
- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬å·²å‡†å¤‡

### ç¯å¢ƒå‡†å¤‡
- [ ] ç›®æ ‡ç¯å¢ƒå·²é…ç½®
- [ ] ç¯å¢ƒå˜é‡å·²è®¾ç½®
- [ ] ä¾èµ–æœåŠ¡å·²ç¡®è®¤
- [ ] å­˜å‚¨ç©ºé—´å……è¶³

### æµ‹è¯•éªŒè¯
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] å®‰å…¨æ‰«æé€šè¿‡
- [ ] Stagingç¯å¢ƒéªŒè¯é€šè¿‡

### å›æ»šå‡†å¤‡
- [ ] å›æ»šæ–¹æ¡ˆå·²å‡†å¤‡
- [ ] å›æ»šè„šæœ¬å·²æµ‹è¯•
- [ ] æ•°æ®åº“å›æ»šè„šæœ¬å·²å‡†å¤‡
- [ ] å›æ»šå†³ç­–æµç¨‹å·²æ˜ç¡®
```

### 2. éƒ¨ç½²æ‰§è¡Œ

```markdown
## éƒ¨ç½²æ­¥éª¤

### 1. å¤‡ä»½
```bash
# æ•°æ®åº“å¤‡ä»½
pg_dump $DB_NAME > backup_$(date +%Y%m%d_%H%M%S).sql

# æ–‡ä»¶å¤‡ä»½
tar -czf backup_$(date +%Y%m%d_%H%M%S).tar.gz /var/www/app
```

### 2. æ•°æ®åº“è¿ç§»
```bash
# æ‰§è¡Œè¿ç§»è„šæœ¬
psql -f migrations/001_add_new_feature.sql

# éªŒè¯è¿ç§»ç»“æœ
psql -c "\d new_table"
```

### 3. ä»£ç éƒ¨ç½²
```bash
# æ‹‰å–ä»£ç 
git pull origin release/v1.2.0

# å®‰è£…ä¾èµ–
npm ci --production

# æ„å»ºåº”ç”¨
npm run build

# é‡å¯æœåŠ¡
pm2 restart app
```

### 4. å¥åº·æ£€æŸ¥
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl -f http://localhost:3000/health || exit 1

# æ£€æŸ¥å…³é”®åŠŸèƒ½
curl -f http://localhost:3000/api/health || exit 1
```

### 5. éªŒè¯éƒ¨ç½²
- [ ] æœåŠ¡æ­£å¸¸å“åº”
- [ ] å…³é”®åŠŸèƒ½å¯ç”¨
- [ ] æ— é”™è¯¯æ—¥å¿—
- [ ] æ€§èƒ½æŒ‡æ ‡æ­£å¸¸
```

### 3. éƒ¨ç½²åéªŒè¯

```markdown
## Post-deployment Verification

### åŠŸèƒ½éªŒè¯
- [ ] ç”¨æˆ·ç™»å½•/æ³¨å†Œ
- [ ] æ ¸å¿ƒä¸šåŠ¡æµç¨‹
- [ ] æ•°æ®è¯»å†™æ­£å¸¸
- [ ] ç¬¬ä¸‰æ–¹é›†æˆæ­£å¸¸

### æ€§èƒ½éªŒè¯
- [ ] å“åº”æ—¶é—´æ­£å¸¸
- [ ] é”™è¯¯ç‡æ— å¼‚å¸¸
- [ ] èµ„æºä½¿ç”¨æ­£å¸¸

### ç›‘æ§éªŒè¯
- [ ] ç›‘æ§æŒ‡æ ‡æ­£å¸¸
- [ ] æ—¥å¿—æ­£å¸¸ä¸ŠæŠ¥
- [ ] å‘Šè­¦é…ç½®ç”Ÿæ•ˆ
```

## å›æ»šæµç¨‹

### å›æ»šè§¦å‘æ¡ä»¶

```markdown
## å›æ»šå†³ç­–

### ç«‹å³å›æ»š
- [ ] æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨
- [ ] æ•°æ®ä¸¢å¤±æˆ–æŸå
- [ ] ä¸¥é‡å®‰å…¨æ¼æ´
- [ ] æ€§èƒ½ä¸¥é‡é€€åŒ–ï¼ˆ>50%ï¼‰

### è¯„ä¼°åå›æ»š
- [ ] éæ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨
- [ ] æ€§èƒ½é€€åŒ–ï¼ˆ20-50%ï¼‰
- [ ] é”™è¯¯ç‡ä¸Šå‡ä½†å¯æ§
- [ ] ç”¨æˆ·ä½“éªŒæ˜æ˜¾ä¸‹é™

### ä¸å›æ»šï¼Œä¿®å¤
- [ ] è½»å¾®é—®é¢˜
- [ ] å·²æœ‰å¿«é€Ÿä¿®å¤æ–¹æ¡ˆ
- [ ] å›æ»šé£é™©å¤§äºä¿®å¤é£é™©
```

### å›æ»šæ‰§è¡Œ

```markdown
## å›æ»šæ­¥éª¤

### 1. ç´§æ€¥åœæ­¢
```bash
# åœæ­¢æœåŠ¡
pm2 stop app

# æˆ–è´Ÿè½½å‡è¡¡æ‘˜é™¤
kubectl rollout pause deployment/app
```

### 2. æ•°æ®åº“å›æ»š
```bash
# æ‰§è¡Œå›æ»šè„šæœ¬
psql -f migrations/001_rollback_add_new_feature.sql

# æˆ–æ¢å¤å¤‡ä»½
psql < backup_20260129_100000.sql
```

### 3. ä»£ç å›æ»š
```bash
# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
git checkout v1.1.0

# é‡æ–°éƒ¨ç½²
npm ci --production
npm run build
pm2 restart app
```

### 4. éªŒè¯å›æ»š
- [ ] æœåŠ¡æ¢å¤æ­£å¸¸
- [ ] æ•°æ®å®Œæ•´æ€§éªŒè¯
- [ ] æ ¸å¿ƒåŠŸèƒ½å¯ç”¨
```

## ç›‘æ§é…ç½®

### 1. åº”ç”¨ç›‘æ§

```markdown
## ç›‘æ§æŒ‡æ ‡

### æ€§èƒ½æŒ‡æ ‡
- **å“åº”æ—¶é—´**: p50/p95/p99
- **ååé‡**: requests/sec
- **é”™è¯¯ç‡**: HTTP 5xx, 4xx
- **é˜Ÿåˆ—æ·±åº¦**: ä»»åŠ¡é˜Ÿåˆ—é•¿åº¦

### èµ„æºæŒ‡æ ‡
- **CPUä½¿ç”¨ç‡**: <80%
- **å†…å­˜ä½¿ç”¨ç‡**: <85%
- **ç£ç›˜ä½¿ç”¨ç‡**: <80%
- **ç½‘ç»œæµé‡**: in/out

### ä¸šåŠ¡æŒ‡æ ‡
- **æ´»è·ƒç”¨æˆ·**: DAU/MAU
- **è®¢å•é‡**: è®¢å•æ•°/æˆåŠŸç‡
- **è½¬åŒ–ç‡**: å…³é”®æµç¨‹è½¬åŒ–
```

### 2. æ—¥å¿—é…ç½®

```yaml
# logging.yml
level: info
format: json

outputs:
  - type: console
    level: debug
  - type: file
    path: /var/log/app/app.log
    level: info
  - type: elasticsearch
    level: warn
```

### 3. å‘Šè­¦é…ç½®

```yaml
# alerts.yml
alerts:
  - name: HighErrorRate
    condition: error_rate > 5%
    duration: 5m
    severity: critical
    channels: [slack, pagerduty]

  - name: HighResponseTime
    condition: p95_response_time > 1s
    duration: 10m
    severity: warning
    channels: [slack]

  - name: HighCPU
    condition: cpu_usage > 90%
    duration: 15m
    severity: warning
    channels: [slack]
```

## Runbookç”Ÿæˆ

### Runbookæ¨¡æ¿

```markdown
# {åº”ç”¨åç§°} Runbook

## æ¦‚è¿°
- åº”ç”¨: {åº”ç”¨åç§°}
- ç‰ˆæœ¬: {ç‰ˆæœ¬å·}
- ç¯å¢ƒ: {ç¯å¢ƒ}
- è´Ÿè´£äºº: {å›¢é˜Ÿ}

## æ¶æ„
```
[æ¶æ„å›¾]
```

## æœåŠ¡ç»„ä»¶
| ç»„ä»¶ | æŠ€æœ¯ | ç«¯å£ | è¯´æ˜ |
|------|------|------|------|
| API | Node.js | 3000 | APIæœåŠ¡ |
| Web | Nginx | 80 | åå‘ä»£ç† |
| DB | PostgreSQL | 5432 | æ•°æ®åº“ |

## å¸¸è§æ“ä½œ

### é‡å¯æœåŠ¡
```bash
pm2 restart app
```

### æŸ¥çœ‹æ—¥å¿—
```bash
pm2 logs app
tail -f /var/log/app/app.log
```

### æ£€æŸ¥å¥åº·
```bash
curl http://localhost:3000/health
```

## æ•…éšœå¤„ç†

### åœºæ™¯1: æœåŠ¡æ— å“åº”
**ç—‡çŠ¶**: APIè¶…æ—¶
**è¯Šæ–­**:
```bash
# æ£€æŸ¥è¿›ç¨‹
ps aux | grep node

# æ£€æŸ¥ç«¯å£
netstat -tlnp | grep 3000

# æ£€æŸ¥æ—¥å¿—
pm2 logs app --lines 100
```

**è§£å†³**:
```bash
# é‡å¯æœåŠ¡
pm2 restart app

# æˆ–å¼ºåˆ¶é‡å¯
pm2 delete app && pm2 start app
```

### åœºæ™¯2: æ•°æ®åº“è¿æ¥å¤±è´¥
**ç—‡çŠ¶**: Database connection error
**è¯Šæ–­**:
```bash
# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
systemctl status postgresql

# æ£€æŸ¥è¿æ¥æ•°
psql -c "SELECT count(*) FROM pg_stat_activity;"

# æ£€æŸ¥æ…¢æŸ¥è¯¢
psql -c "SELECT * FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;"
```

**è§£å†³**:
```bash
# é‡å¯æ•°æ®åº“
systemctl restart postgresql

# æˆ–æ¸…ç†è¿æ¥
psql -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE state = 'idle';"
```

### åœºæ™¯3: å†…å­˜æ³„æ¼
**ç—‡çŠ¶**: å†…å­˜æŒç»­å¢é•¿
**è¯Šæ–­**:
```bash
# æ£€æŸ¥å†…å­˜ä½¿ç”¨
pm2 monit

# ç”Ÿæˆheap snapshot
kill -USR2 $(pidof node)
```

**è§£å†³**:
```bash
# é‡å¯æœåŠ¡
pm2 restart app

# æˆ–è‡ªåŠ¨é‡å¯ï¼ˆpm2é…ç½®ï¼‰
pm2 install pm2-auto-tinder
```

## ç´§æ€¥è”ç³»
- å¼€å‘è´Ÿè´£äºº: {å§“å} - {ç”µè¯}
- è¿ç»´è´Ÿè´£äºº: {å§“å} - {ç”µè¯}
- on-call: {è½®å€¼ä¿¡æ¯}

## ç›¸å…³æ–‡æ¡£
- [æ¶æ„æ–‡æ¡£]({é“¾æ¥})
- [APIæ–‡æ¡£]({é“¾æ¥})
- [ç›‘æ§é¢æ¿]({é“¾æ¥})
```

## Release Notesæ¨¡æ¿

```markdown
# Release {ç‰ˆæœ¬å·}

**å‘å¸ƒæ—¥æœŸ**: {YYYY-MM-DD}
**å‘å¸ƒäºº**: {å§“å}

## ğŸ‰ æ–°åŠŸèƒ½
- {æ–°åŠŸèƒ½1æè¿°}
- {æ–°åŠŸèƒ½2æè¿°}

## ğŸ› Bugä¿®å¤
- {bug1æè¿°}
- {bug2æè¿°}

## âš¡ æ€§èƒ½ä¼˜åŒ–
- {ä¼˜åŒ–1æè¿°}
- {ä¼˜åŒ–2æè¿°}

## ğŸ”§ é…ç½®å˜æ›´
- {é…ç½®å˜æ›´æè¿°}

## ğŸ“ æ–‡æ¡£æ›´æ–°
- {æ–‡æ¡£æ›´æ–°æè¿°}

## ğŸš¨ éƒ¨ç½²æ³¨æ„äº‹é¡¹
- {æ³¨æ„äº‹é¡¹}
- {è¿ç§»è¯´æ˜}
- {é…ç½®è¦æ±‚}

## ğŸ“Š ç›¸å…³èµ„æº
- [PR #{ç¼–å·}]({é“¾æ¥})
- [Issue #{ç¼–å·}]({é“¾æ¥})
- [JIRA ticket]({é“¾æ¥})
```

## éƒ¨ç½²æœ€ä½³å®è·µ

### 1. è“ç»¿éƒ¨ç½²
```
â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”
â”‚ Blueâ”‚ â†’ â†’ â”‚ Greenâ”‚ (åˆ‡æ¢)
â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”˜
```

### 2. é‡‘ä¸é›€å‘å¸ƒ
```
10% â†’ 50% â†’ 100%
 (é‡‘ä¸é›€)  (å…¨é‡)
```

### 3. æ»šåŠ¨å‘å¸ƒ
```
Pod1 â†’ Pod2 â†’ Pod3 â†’ ...
 (é€ä¸ªæ›´æ–°)
```

---

**ç»´æŠ¤**: æ ¹æ®éƒ¨ç½²ç»éªŒæŒç»­ä¼˜åŒ–
**æ¥æº**: Cursor Hi Offer deployment-and-ops
**ç›¸å…³**: versioning-and-release, ios-simulator-deployment
